const API_KEY = 'AIzaSyD6eAik...'; // Replace with your actual API key
const CLIENT_ID = '1065961533552-4ukc1utf902uldqfq3nvcmrohjehbd2e.apps.googleusercontent.com'; // Replace with your actual Client ID
const SPREADSHEET_ID = '1bZIxAmb2-E3naVHbggvAs4nOAUi0J6XIcGMyU2Bmc5w';
const RANGE = 'Drip & COTD!A12:S';

function initClient() {
    gapi.load('client:auth2', () => {
        gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            scope: 'https://www.googleapis.com/auth/spreadsheets',
        }).then(() => {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                getData(); // Fetch data after sign-in
            });
        }).catch((error) => {
            console.error('Error loading GAPI client', error);
        });
    });
}

function getData() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
    }).then((response) => {
        const data = response.result.values;
        const filteredData = filterByDate(data, startDate, endDate);
        displayData(filteredData);
    }).catch((error) => {
        console.error('Error fetching data', error);
    });
}

function filterByDate(data, startDate, endDate) {
    const filteredData = data.filter(row => {
        const rowDate = new Date(row[0]); // Assuming date is in the first column
        const start = new Date(startDate);
        const end = new Date(endDate);
        return rowDate >= start && rowDate <= end;
    });
    return filteredData;
}

function displayData(data) {
    const tableBody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = ''; // Clear previous data

    data.forEach((row) => {
        const tr = document.createElement('tr');

        // Add checkbox with status from column S
        const checkboxTd = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = row[18] === 'TRUE'; // Assuming checkbox is in column S (18th index)
        checkbox.addEventListener('change', () => updateCheckbox(row[0], checkbox.checked)); // Assuming the row ID is in column A
        checkboxTd.appendChild(checkbox);
        tr.appendChild(checkboxTd);

        // Add other columns
        const columns = [
            row[16],  // الاجراء
            row[13],  // التركيز المناسب TDS%
            row[11],  // الطحنة
            row[10],  // الفرع
            row[6],   // نسبة التركيز TDS%
            row[3],   // المحصول
            row[1],   // اسم الموظف
            row[0],   // التاريخ
        ];

        columns.forEach(col => {
            const td = document.createElement('td');
            td.textContent = col || ''; // Handle empty values
            tr.appendChild(td);
        });

        tableBody.appendChild(tr);
    });
}

function updateCheckbox(rowId, isChecked) {
    const range = `Drip & COTD!S${rowId}:S${rowId}`;
    const value = isChecked ? 'TRUE' : 'FALSE';

    gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: range,
        valueInputOption: 'USER_ENTERED',
        resource: { values: [[value]] },
    }).then(() => {
        console.log('Checkbox updated successfully');
    }).catch((error) => {
        console.error('Error updating checkbox:', error);
    });
}

document.getElementById('applyFilter').addEventListener('click', getData);

document.addEventListener("DOMContentLoaded", function() {
    gapi.load('client:auth2', initClient);
});
