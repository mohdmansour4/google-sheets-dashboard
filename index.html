<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  <meta http-equiv="pragma" content="no-cache">
  <title>مؤشر أداء حاسبة الاستخلاص لفرع عُمق 1.3</title>
  <style>
    body { font-family: Verdana, sans-serif; text-align: center; }
    h1 { color: cornflowerblue; }
    table { margin: 20px auto; width: 80%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #acc9fe; }
    button { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; }
    button:hover { background-color: #45a049; }
  </style>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>مؤشر أداء حاسبة الاستخلاص لفرع عُمق 1.3</h1>
  <p>يقوم مؤشر الاداء بعرض العينات المرفوعة لآخر ٣٠ يوم من الاحدث الى الاقدم، والامكان تغيير المدة المحددة من خانة التاريخ.</p>

  <!-- Date Filter UI -->
  <label for="startDate">من:</label>
  <input type="date" id="startDate">
  <label for="endDate">الى:</label>
  <input type="date" id="endDate">
  <button id="applyFilter">تنفيذ</button>

  <!-- Data Table -->
  <table id="dataTable">
    <thead>
      <tr>
        <th>التاريخ</th>
        <th>اسم الموظف</th>
        <th>المحصول</th>
        <th>%TDS نسبة التركيز</th>
        <th>الفرع</th>
        <th>الطحنة</th>
        <th>%TDS التركيز المناسب</th>
        <th>الاجراء</th>
        <th>Column S (CHECKBOX)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const CLIENT_ID = '1065961533552-4ukc1utf902uldqfq3nvcmrohjehbd2e.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyD6eAikKznWps9K8GcflqPy03-L7KTUaWE';
    const SPREADSHEET_ID = '1bZIxAmb2-E3naVHbggvAs4nOAUi0J6XIcGMyU2Bmc5w';
    const RANGE = 'Drip & COTD!A12:S';

    function initClient() {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
          scope: 'https://www.googleapis.com/auth/spreadsheets',
        }).then(() => {
          return gapi.auth2.getAuthInstance().signIn();
        }).then(() => {
          getData();
        }).catch((error) => {
          console.error('Error initializing Google API client:', error);
        });
      });
    }

    function getData() {
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
      }).then((response) => {
        const data = response.result.values;
        if (data && data.length > 0) {
          displayData(data);
        } else {
          console.log('No data found.');
        }
      }).catch((error) => {
        console.error('Error fetching data:', error);
      });
    }

    function displayData(data) {
      const tableBody = document.querySelector('#dataTable tbody');
      tableBody.innerHTML = '';  // Clear previous table data
      data.forEach((row) => {
        const tr = document.createElement('tr');
        row.forEach((cell) => {
          const td = document.createElement('td');
          td.textContent = cell || '';  // Fill with empty string if cell is empty
          tr.appendChild(td);
        });

        // Add checkbox to the last column (Column S)
        const checkboxTd = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = row[18] === 'TRUE';  // Check if the cell in column S is TRUE
        checkbox.addEventListener('change', (event) => {
          updateCheckbox(row[0], event.target.checked);  // Update the checkbox value in Sheets
        });
        checkboxTd.appendChild(checkbox);
        tr.appendChild(checkboxTd);

        tableBody.appendChild(tr);
      });
    }

    function updateCheckbox(rowNumber, isChecked) {
      const value = isChecked ? 'TRUE' : 'FALSE';
      const range = `S${rowNumber}:S${rowNumber}`;  // Update the specific row in Column S

      gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: range,
        valueInputOption: 'USER_ENTERED',
        values: [[value]],
      }).then(() => {
        console.log('Checkbox updated successfully.');
      }).catch((error) => {
        console.error('Error updating checkbox:', error);
      });
    }

    // Initialize the API client on page load
    window.onload = function() {
      gapi.load('client:auth2', initClient);
    };
  </script>
</body>
</html>
